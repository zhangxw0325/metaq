<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=gb2312">
<meta name=Generator content="Microsoft Word 12 (filtered)">
<title>METAQ STORE Q&amp;A</title>
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:宋体;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:黑体;
	panose-1:2 1 6 9 6 1 1 1 1 1;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Cambria;
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:"YaHei Consolas Hybrid";
	panose-1:2 11 5 3 2 2 4 2 2 4;}
@font-face
	{font-family:"\@YaHei Consolas Hybrid";
	panose-1:2 11 5 3 2 2 4 2 2 4;}
@font-face
	{font-family:"\@宋体";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"\@黑体";
	panose-1:2 1 6 9 6 1 1 1 1 1;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:"Calibri","sans-serif";}
h1
	{mso-style-link:"标题 1 Char";
	margin-top:17.0pt;
	margin-right:0cm;
	margin-bottom:16.5pt;
	margin-left:21.6pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-21.6pt;
	line-height:240%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Calibri","sans-serif";}
h2
	{mso-style-link:"标题 2 Char";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:28.8pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-28.8pt;
	line-height:173%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Cambria","serif";}
h3
	{mso-style-link:"标题 3 Char";
	margin-top:13.0pt;
	margin-right:0cm;
	margin-bottom:13.0pt;
	margin-left:36.0pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-36.0pt;
	line-height:173%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Calibri","sans-serif";}
h4
	{mso-style-link:"标题 4 Char";
	margin-top:14.0pt;
	margin-right:0cm;
	margin-bottom:14.5pt;
	margin-left:43.2pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-43.2pt;
	line-height:156%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Cambria","serif";}
h5
	{mso-style-link:"标题 5 Char";
	margin-top:14.0pt;
	margin-right:0cm;
	margin-bottom:14.5pt;
	margin-left:50.4pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-50.4pt;
	line-height:156%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Calibri","sans-serif";}
h6
	{mso-style-link:"标题 6 Char";
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.2pt;
	margin-left:57.6pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-57.6pt;
	line-height:133%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Cambria","serif";}
p.MsoHeading7, li.MsoHeading7, div.MsoHeading7
	{mso-style-link:"标题 7 Char";
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.2pt;
	margin-left:64.8pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-64.8pt;
	line-height:133%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Calibri","sans-serif";
	font-weight:bold;}
p.MsoHeading8, li.MsoHeading8, div.MsoHeading8
	{mso-style-link:"标题 8 Char";
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.2pt;
	margin-left:72.0pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-72.0pt;
	line-height:133%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Cambria","serif";}
p.MsoHeading9, li.MsoHeading9, div.MsoHeading9
	{mso-style-link:"标题 9 Char";
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.2pt;
	margin-left:79.2pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:-79.2pt;
	line-height:133%;
	page-break-after:avoid;
	font-size:10.5pt;
	font-family:"Cambria","serif";}
p.MsoToc1, li.MsoToc1, div.MsoToc1
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.5pt;
	font-family:"Calibri","sans-serif";}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{mso-style-link:"页眉 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:center;
	layout-grid-mode:char;
	border:none;
	padding:0cm;
	font-size:9.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{mso-style-link:"页脚 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	layout-grid-mode:char;
	font-size:9.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoCaption, li.MsoCaption, div.MsoCaption
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:10.0pt;
	font-family:"Cambria","serif";}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;}
p.MsoDocumentMap, li.MsoDocumentMap, div.MsoDocumentMap
	{mso-style-link:"文档结构图 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:9.0pt;
	font-family:宋体;}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{mso-style-link:"批注框文本 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	font-size:9.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoNoSpacing, li.MsoNoSpacing, div.MsoNoSpacing
	{mso-style-link:"无间隔 Char";
	margin:0cm;
	margin-bottom:.0001pt;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin:0cm;
	margin-bottom:.0001pt;
	text-align:justify;
	text-justify:inter-ideograph;
	text-indent:21.0pt;
	font-size:10.5pt;
	font-family:"Calibri","sans-serif";}
p.MsoTocHeading, li.MsoTocHeading, div.MsoTocHeading
	{margin-top:24.0pt;
	margin-right:0cm;
	margin-bottom:0cm;
	margin-left:0cm;
	margin-bottom:.0001pt;
	line-height:115%;
	page-break-after:avoid;
	font-size:14.0pt;
	font-family:"Cambria","serif";
	color:#365F91;
	font-weight:bold;}
span.Char
	{mso-style-name:"页眉 Char";
	mso-style-link:页眉;}
span.Char0
	{mso-style-name:"页脚 Char";
	mso-style-link:页脚;}
span.Char1
	{mso-style-name:"无间隔 Char";
	mso-style-link:无间隔;}
span.Char2
	{mso-style-name:"批注框文本 Char";
	mso-style-link:批注框文本;}
span.1Char
	{mso-style-name:"标题 1 Char";
	mso-style-link:"标题 1";
	font-family:"YaHei Consolas Hybrid","sans-serif";
	font-weight:bold;}
span.2Char
	{mso-style-name:"标题 2 Char";
	mso-style-link:"标题 2";
	font-family:"Cambria","serif";
	font-weight:bold;}
span.3Char
	{mso-style-name:"标题 3 Char";
	mso-style-link:"标题 3";
	font-weight:bold;}
span.4Char
	{mso-style-name:"标题 4 Char";
	mso-style-link:"标题 4";
	font-family:"Cambria","serif";
	font-weight:bold;}
span.5Char
	{mso-style-name:"标题 5 Char";
	mso-style-link:"标题 5";
	font-weight:bold;}
span.6Char
	{mso-style-name:"标题 6 Char";
	mso-style-link:"标题 6";
	font-family:"Cambria","serif";
	font-weight:bold;}
span.7Char
	{mso-style-name:"标题 7 Char";
	mso-style-link:"标题 7";
	font-weight:bold;}
span.8Char
	{mso-style-name:"标题 8 Char";
	mso-style-link:"标题 8";
	font-family:"Cambria","serif";}
span.9Char
	{mso-style-name:"标题 9 Char";
	mso-style-link:"标题 9";
	font-family:"Cambria","serif";}
span.Char3
	{mso-style-name:"文档结构图 Char";
	mso-style-link:文档结构图;
	font-family:宋体;}
 /* Page Definitions */
 @page WordSection1
	{size:595.3pt 841.9pt;
	margin:36.0pt 36.0pt 36.0pt 36.0pt;
	layout-grid:15.6pt;}
div.WordSection1
	{page:WordSection1;}
@page WordSection2
	{size:595.3pt 841.9pt;
	margin:36.0pt 36.0pt 36.0pt 36.0pt;
	layout-grid:15.6pt;}
div.WordSection2
	{page:WordSection2;}
@page WordSection3
	{size:595.3pt 841.9pt;
	margin:36.0pt 36.0pt 36.0pt 36.0pt;
	layout-grid:15.6pt;}
div.WordSection3
	{page:WordSection3;}
 /* List Definitions */
 ol
	{margin-bottom:0cm;}
ul
	{margin-bottom:0cm;}
-->
</style>

</head>

<body lang=ZH-CN link=blue vlink=purple style='text-justify-trim:punctuation'>

<div class=WordSection1 style='layout-grid:15.6pt'>

<div align=center>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width="100%"
 style='width:100.0%;border-collapse:collapse'>
 <tr style='height:144.0pt'>
  <td width="100%" valign=top style='width:100.0%;padding:0cm 5.4pt 0cm 5.4pt;
  height:144.0pt'>
  <p class=MsoNoSpacing align=center style='text-align:center'><span
  lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif";
  text-transform:uppercase'>&nbsp;</span></p>
  </td>
 </tr>
 <tr style='height:72.0pt'>
  <td width="100%" style='width:100.0%;border:none;border-bottom:solid #4F81BD 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:72.0pt'>
  <p class=MsoNoSpacing align=center style='text-align:center'><b><span
  lang=EN-US style='font-size:36.0pt;font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ
  STORE Q&amp;A</span></b></p>
  </td>
 </tr>
 <tr style='height:36.0pt'>
  <td width="100%" style='width:100.0%;border:none;padding:0cm 5.4pt 0cm 5.4pt;
  height:36.0pt'>
  <p class=MsoNoSpacing align=center style='text-align:center'><span
  style='font-size:15.0pt;font-family:"YaHei Consolas Hybrid","sans-serif"'>（针对<span
  lang=EN-US>2.X</span>版本）</span></p>
  </td>
 </tr>
 <tr style='height:18.0pt'>
  <td width="100%" style='width:100.0%;padding:0cm 5.4pt 0cm 5.4pt;height:18.0pt'>
  <p class=MsoNoSpacing align=center style='text-align:center'><span
  lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>&nbsp;</span></p>
  </td>
 </tr>
 <tr style='height:18.0pt'>
  <td width="100%" style='width:100.0%;padding:0cm 5.4pt 0cm 5.4pt;height:18.0pt'>
  <p class=MsoNoSpacing align=center style='text-align:center'><b><span
  style='font-family:"YaHei Consolas Hybrid","sans-serif"'>誓嘉<span lang=EN-US>
  vintage.wang@gmail.com</span></span></b></p>
  </td>
 </tr>
 <tr style='height:18.0pt'>
  <td width="100%" style='width:100.0%;padding:0cm 5.4pt 0cm 5.4pt;height:18.0pt'>
  <p class=MsoNoSpacing align=center style='text-align:center'><span
  lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>2013/1/5</span></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNoSpacing></p>

</div>

<span lang=EN-US style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif"'><br
clear=all style='page-break-before:always'>
</span>

<div class=WordSection2 style='layout-grid:15.6pt'>

<p class=MsoNormal align=center style='text-align:center'><b><span
style='font-size:14.0pt;font-family:"YaHei Consolas Hybrid","sans-serif"'>目录</span></b></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176930"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>1</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>写入物理文件成功，但是写入逻辑文件失败怎么办？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176931"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>2</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>写完物理文件后，索引信息是同步写入逻辑文件还是异步写入？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176932"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>3</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>异步写索引是单线程还是多线程？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176933"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>4</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>Consumer</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>拉消息是单个方式还是批量方式拉？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176934"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>5</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>存储层大量使用了mmap</span></span><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>内存文件映射，是否会超出系统句柄限制？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>1</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176935"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>6</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>异步刷盘方式，是否会导致内存爆掉？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>2</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176936"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>7</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>Consumer</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>拉消息是否使用了sendfile</span></span><span lang=EN-US style='font-family:
"YaHei Consolas Hybrid","sans-serif"'><span lang=EN-US>？</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>2</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176937"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>8</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>所有文件都映射至内存，所占用的物理内存比例如何控制？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176938"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>9</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>PAGECACHE</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>使用过多，是否会影响swap</span></span><span lang=EN-US style='font-family:
"YaHei Consolas Hybrid","sans-serif"'><span lang=EN-US>？</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176939"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>10</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>JVM CRASH</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>后，写入PAGECACHE</span></span><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>的未刷盘数据是否会丢失？</span></span><span style='color:windowtext;display:
none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176940"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>11</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>PAGECACHE</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>映射总大小是否有限制？</span></span><span style='color:windowtext;display:none;
text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>3</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176941"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>12</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>是否可以认为Linux64</span></span><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>位可以无限制映射PAGECACHE</span></span><span lang=EN-US style='font-family:
"YaHei Consolas Hybrid","sans-serif"'><span lang=EN-US>？</span></span><span
style='color:windowtext;display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>4</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176942"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>13</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>消息如何在java</span></span><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>堆，物理内存，虚拟内存，磁盘之间流动？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>5</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176943"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>14</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>物理分区与逻辑分区使用long</span></span><span lang=EN-US style='font-family:
"YaHei Consolas Hybrid","sans-serif"'><span lang=EN-US>类型标识offset</span></span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>，是否会溢出？</span></span><span style='color:windowtext;display:none;
text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>6</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176944"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>15</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ Server</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>关闭时，数据安全性如何保证？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>7</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176945"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>16</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ Server</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>重启时，如何Load</span></span><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>数据？</span></span><span style='color:windowtext;display:none;
text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>7</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176946"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>17</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>如何区别是正常退出还是异常退出？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>8</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176947"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>18</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>有哪些自我保护措施？</span></span><span style='color:windowtext;display:none;
text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>8</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176948"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>19</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>是否需要流控？</span></span><span style='color:windowtext;display:none;
text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176949"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>20</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>为什么可以支持海量（1</span></span><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>万以上）分区？</span></span><span style='color:windowtext;display:none;
text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176950"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>21</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>Java</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>中使用MapedByteBuffer</span></span><span lang=EN-US style='font-family:
"YaHei Consolas Hybrid","sans-serif"'><span lang=EN-US>可能会使JVM CRASH</span></span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>，METAQ</span></span><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>如何避免？</span></span><span style='color:windowtext;display:none;
text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>9</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176951"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>22</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ2.0</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>版本较1.4</span></span><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>版性能提升的主要原因是什么？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>10</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176952"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>23</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>订阅关系丢失，是否也会丢失消息？</span></span><span style='color:windowtext;
display:none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>11</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176953"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>24</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>存储层的刷盘策略是什么？</span></span><span style='color:windowtext;display:
none;text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>11</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176954"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>25</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>存储层目录结构？</span></span><span style='color:windowtext;display:none;
text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>12</span></a></span></p>

<p class=MsoToc1><span lang=EN-US><a href="#_Toc345176955"><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>26</span><span
style='color:windowtext;text-decoration:none'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'><span
lang=EN-US>存储层视图？</span></span><span style='color:windowtext;display:none;
text-decoration:none'>... </span><span
style='color:windowtext;display:none;text-decoration:none'>13</span></a></span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<span lang=EN-US style='font-size:10.5pt;font-family:"Calibri","sans-serif"'><br
clear=all style='page-break-before:always'>
</span></div>

<span lang=EN-US style='font-size:10.5pt;font-family:"Calibri","sans-serif"'><br
clear=all style='page-break-before:always'>
</span>

<div class=WordSection3 style='layout-grid:15.6pt'>

<h1><a name="_Toc345176930"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>1<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>写入物理文件成功，但是写入逻辑文件失败怎么办？</span></a></h1>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>JVM
CRASH</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>情况下，索引未写入逻辑文件，如何处理？</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>JVM</span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>重启后，从物理文件恢复逻辑文件，非全量恢复，只恢复当前可能丢失的数据</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>写入逻辑文件发生<span
lang=EN-US>IO</span>错误如何处理？</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>一旦发生<span lang=EN-US>IO</span>错误，则认为可能是<span
lang=EN-US>IO</span>设备故障，停止对外写服务，但是数据仍然可读。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>JVM
</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>发生<span
lang=EN-US>outofmemory</span></span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>这种情况，可理解为<span
lang=EN-US>jvm</span>不能对外服务，逻辑队列与物理队列可能不一致。必须重启才能保证消息一致。</span></p>

<h1><a name="_Toc345176931"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>2<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>写完物理文件后，索引信息是同步写入逻辑文件还是异步写入？</span></a></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>消息一旦写入物理文件，则返回消息对应的物理</span><span
lang=EN-US>offset</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，</span><span
lang=EN-US>size</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，等信息，将这类索引信息传递至另一个独立的</span><span
lang=EN-US>Dispatch</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>线程，然后主流程返回，并向发送方返回成功应答。</span></p>

<h1><a name="_Toc345176932"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>3<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>异步写索引是单线程还是多线程？</span></a></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>单线程，可保证消息顺序。</span></p>

<h1><a name="_Toc345176933"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>4<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>Consumer</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>拉消息是单个方式还是批量方式拉？</span></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>是批量方式拉消息，服务器可以配置一次最多拉多少条，最多多少字节，客户端也可以配置。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>以最小的为主。</span></p>

<h1><a name="_Toc345176934"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>5<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>存储层大量使用了<span
lang=EN-US>mmap</span>内存文件映射，是否会超出系统句柄限制？</span></a></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>不会。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>系统默认值</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>vm.max_map_count
= 65536</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>可以通过以下方式修改</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>sudo sysctl vm.max_map_count=655360</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>同时需要关注以下参数</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>[shijia.wxr@dev170021
~]$ ulimit -a&nbsp; </span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>open
files&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(-n) 131072</span></p>

<h1><a name="_Toc345176935"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>6<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>异步刷盘方式，是否会导致内存爆掉？</span></a></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>不会。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>消息写入</span><span
lang=EN-US>pagecache</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>后，直接通知刷盘线程开始刷盘，并返回，也就是说刷盘线程处于实时刷盘状态。但是也不排除前端发消息压力大、而且后端消费消息堆积程度严重，造成消息不能及时刷盘，在内存堆积过多的情况。这种情况下，当内存未刷盘数据达到一定程度，就开始阻塞前端写</span><span
lang=EN-US>pagecache</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>操作。（实际是每次都尝试刷盘</span><span
lang=EN-US>32</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>个</span><span
lang=EN-US>page</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>才返回）</span>
<span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>。具体阀值参见以下参数。</span></p>

<p class=MsoNormal style='text-indent:21.0pt'><span lang=EN-US>vm.dirty_bytes=20000000000</span></p>

<h1><a name="_Toc345176936"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>7<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>Consumer</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>拉消息是否使用了<span
lang=EN-US>sendfile</span>？</span></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>Server</span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>在向</span><span
lang=EN-US>Consumer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>返回消息时，没有直接使用</span><span
lang=EN-US>sendfile</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>（</span><span
lang=EN-US>transferTo</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>）接口，但是使用了类似机制，直接将虚拟内存地址传给</span><span
lang=EN-US>socket</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，无论实际数据是在物理内存还是在文件，都由操作系统进行管理，也就是说消息数据不会重新</span><span
lang=EN-US>load</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>到</span><span
lang=EN-US>java</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>堆。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>另外：将</span><span
lang=EN-US>pagecache</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>直接传输给</span><span
lang=EN-US>socket</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，在操作系统层面会做以下优化</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>因为</span><span
lang=EN-US>pagecache</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>内存本身是内核与应用共享的内存，所以不需要用户态向内核态内存拷贝。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>Socket</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>在发现是</span><span
lang=EN-US>pagecache</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>时，会将</span><span
lang=EN-US>pagecache</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>直接传输，不需要将数据拷贝到</span><span
lang=EN-US>socket</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>缓冲区。（</span><span
lang=EN-US>TCP</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>协议栈优化）</span></p>

<h1><a name="_Toc345176937"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>8<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>所有文件都映射至内存，所占用的物理内存比例如何控制？</span></a></h1>

<p class=MsoNormal align=left style='margin-left:21.0pt;text-align:left'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>可通过以下参数来控制</span><span
lang=EN-US>server</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>占用的物理内存比例</span></p>

<p class=MsoNormal align=left style='margin-left:21.0pt;text-align:left'><span
lang=EN-US>sudo sysctl vm.min_free_kbytes=7000000</span></p>

<h1><a name="_Toc345176938"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>9<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>PAGECACHE</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>使用过多，是否会影响<span
lang=EN-US>swap</span>？</span></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>Pagecache</span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>与</span><span
lang=EN-US>swap</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>是两个独立的机制，即使映射</span><span
lang=EN-US>1T</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>的</span><span
lang=EN-US>pagecache</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，也不会有过多的</span><span
lang=EN-US>swap</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，且可以通过以下命令来关闭系统的</span><span
lang=EN-US>swap</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>机制。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>sudo swapoff Ca</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>也可以设定以下参数，令系统尽可能不要</span><span
lang=EN-US>swap</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>sudo sysctl
vm.swappiness=0</span></p>

<h1><a name="_Toc345176939"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>10<span
style='font:7.0pt "Times New Roman"'> </span></span><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>JVM CRASH</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>后，写入<span lang=EN-US>PAGECACHE</span>的未刷盘数据是否会丢失？</span></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>不会。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>为了避免</span><span
lang=EN-US>os</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>本身的刷盘机制与应用自己的刷盘机制冲突，设置了以下参数来抑制</span><span
lang=EN-US>os</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>刷盘。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>sudo sysctl
vm.dirty_writeback_centisecs=360000</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>但是同时会导致</span><span
lang=EN-US> JVM CRASH</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>后，系统的</span><span
lang=EN-US>pagecache</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>不能及时刷盘，此时可以通过以下命令来刷盘</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>sync</span></p>

<h1><a name="_Toc345176940"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>11<span
style='font:7.0pt "Times New Roman"'> </span></span><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>PAGECACHE</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>映射总大小是否有限制？</span></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>32</span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>位</span><span
lang=EN-US>linux</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>存在地址空间</span><span
lang=EN-US>4G</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>的限制，所以</span><span
lang=EN-US>metaq</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>不适合在</span><span
lang=EN-US>32</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>位机器上运行。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>Win32</span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>默认限制为</span><span
lang=EN-US>2G</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，更不适合。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>关于在</span><span
lang=EN-US>64</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>位机器上，</span><span
lang=EN-US>pagecache</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>是否有限制？</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>理论上，</span><span
lang=EN-US>64</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>位机器地址空间可认为无限大（但是实际由于</span><span
lang=EN-US>cpu</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>地址空间限制，可能会小于</span><span
lang=EN-US>2</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>的</span><span
lang=EN-US>64</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>次方）。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>以下为线上</span><span
lang=EN-US>96G 64</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>位</span><span
lang=EN-US>linux</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，</span><span
lang=EN-US>3.2T</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>磁盘空间机器运行截图</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>注：是用</span><span
lang=EN-US>c</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>写的一个简单测试程序，不断尝试调用</span><span
lang=EN-US>mmap</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>接口，并且向里面写数据，只有写数据才会实际分配内存地址。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>代码详见以下网址：</span></p>

<p class=MsoNormal align=left style='margin-left:21.0pt;text-align:left'><span
lang=EN-US><a href="https://gist.github.com/3735144">https://gist.github.com/3735144</a></span></p>

<p class=MsoNormal align=left style='margin-left:21.0pt;text-align:left'><span
lang=EN-US><img border=0 width=670 height=200 id="图片 1"
src="storeqa.files/image001.jpg"></span></p>

<h1><a name="_Toc345176941"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>12<span
style='font:7.0pt "Times New Roman"'> </span></span><span style='font-family:
"YaHei Consolas Hybrid","sans-serif"'>是否可以认为<span lang=EN-US>Linux64</span>位可以无限制映射<span
lang=EN-US>PAGECACHE</span>？</span></a></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>Pagecache</span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>是由内核维护的，映射的越多，内核数据结构占用的物理内存越大，所以要映射更多的</span><span
lang=EN-US>pagecache</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，对机器的物理内存大小要求更高。</span></p>

<h1><a name="_Toc345176942"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>13<span
style='font:7.0pt "Times New Roman"'> </span></span><span style='font-family:
"YaHei Consolas Hybrid","sans-serif"'>消息如何在<span lang=EN-US>java</span>堆，物理内存，虚拟内存，磁盘之间流动？</span></a></h1>

<p class=MsoNormal align=left style='margin-left:21.0pt;text-align:left;
page-break-after:avoid'><span lang=EN-US><img border=0 width=585 height=394
src="storeqa.files/image002.png"></span></p>

<p class=MsoCaption align=left style='text-align:left'><span style='font-family:
黑体'>图表</span> <span
lang=EN-US>1</span><span style='font-family:黑体'>消息数据流图（机器视图）</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>(1).<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Producer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>发送消息，消息从</span><span
lang=EN-US>socket</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>进入</span><span
lang=EN-US>java</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>堆。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>(2).<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Producer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>发送消息，消息从</span><span
lang=EN-US>java</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>堆转入</span><span
lang=EN-US>PAGACACHE</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，物理内存。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>(3).<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Producer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>发送消息，由异步线程刷盘，消息从</span><span
lang=EN-US>PAGECACHE</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>刷入磁盘。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>(4).<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Consumer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>拉消息（正常消费），消息直接从</span><span
lang=EN-US>PAGECACHE</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>（数据在物理内存）转入</span><span
lang=EN-US>socket</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，到达</span><span
lang=EN-US>consumer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，不经过</span><span
lang=EN-US>java</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>堆。</span></p>

<p class=MsoNormal style='margin-left:42.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>这种消费场景最多，线上</span><span
lang=EN-US>96G</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>物理内存，按照</span><span
lang=EN-US>1K</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>消息算，可以在物理内存缓存</span><span
lang=EN-US>1</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>亿条消息。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>(5).<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Consumer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>拉消息（异常消费），消息直接从</span><span
lang=EN-US>PAGECACHE</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>（数据在虚拟内存）转入</span><span
lang=EN-US>socket</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>(6).<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Consumer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>拉消息（异常消费），由于</span><span
lang=EN-US>Socket</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>访问了虚拟内存，产生缺页中断，此时会产生磁盘</span><span
lang=EN-US>IO</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，从磁盘</span><span
lang=EN-US>Load</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>消息到</span><span
lang=EN-US>PAGECACHE</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，然后直接从</span><span
lang=EN-US>socket</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>发出去。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>(7).<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>同</span><span
lang=EN-US>5</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>一致。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>(8).<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>同</span><span
lang=EN-US>6</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>一致。</span></p>

<h1><a name="_Toc345176943"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>14<span
style='font:7.0pt "Times New Roman"'> </span></span><span style='font-family:
"YaHei Consolas Hybrid","sans-serif"'>物理分区与逻辑分区使用<span lang=EN-US>long</span>类型标识<span
lang=EN-US>offset</span>，是否会溢出？</span></a></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>参见下表</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width=555
 style='width:416.0pt;margin-left:24.45pt;border-collapse:collapse'>
 <tr style='height:50.7pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  background:#00B050;padding:0cm 5.4pt 0cm 5.4pt;height:50.7pt'>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>消息大小</span></b></p>
  </td>
  <td width=201 style='width:151.0pt;border:solid windowtext 1.0pt;border-left:
  none;background:#00B050;padding:0cm 5.4pt 0cm 5.4pt;height:50.7pt'>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>每天单台<span lang=EN-US> SERVER</span>消息量<span lang=EN-US><br>
  </span>（单位亿）</span></b></p>
  </td>
  <td width=271 style='width:203.0pt;border:solid windowtext 1.0pt;border-left:
  none;background:#00B050;padding:0cm 5.4pt 0cm 5.4pt;height:50.7pt'>
  <p class=MsoNormal align=center style='text-align:center'><b><span
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>单台<span lang=EN-US> METAQ SERVER</span>可持续运行时间<span lang=EN-US><br>
  </span>（单位年）</span></b></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>256</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>10</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>98709.03293</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>512</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>10</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>49354.51646</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>1024</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>10</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>24677.25823</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>2048</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>10</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>12338.62912</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>4096</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>10</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>6169.314558</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>256</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>100</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>9870.903293</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>512</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>100</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>4935.451646</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>1024</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>100</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>2467.725823</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>2048</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>100</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>1233.862912</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>4096</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>100</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>616.9314558</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>256</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>1000</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>987.0903293</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>512</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>1000</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>493.5451646</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>1024</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>1000</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>246.7725823</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>2048</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>1000</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>123.3862912</span></p>
  </td>
 </tr>
 <tr style='height:15.0pt'>
  <td width=83 nowrap style='width:62.0pt;border:solid windowtext 1.0pt;
  border-top:none;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>4096</span></p>
  </td>
  <td width=201 nowrap style='width:151.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>1000</span></p>
  </td>
  <td width=271 nowrap style='width:203.0pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  background:gray;padding:0cm 5.4pt 0cm 5.4pt;height:15.0pt'>
  <p class=MsoNormal align=center style='text-align:center'><span lang=EN-US
  style='font-size:11.0pt;font-family:"YaHei Consolas Hybrid","sans-serif";
  color:black'>61.69314558</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>由此可知，单台</span><span
lang=EN-US>metaq server</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，按照</span><span
lang=EN-US>4K</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>消息，一天接收</span><span
lang=EN-US>1000</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>亿条消息，可以连续运行</span><span
lang=EN-US>61</span></p>

<h1><a name="_Toc345176944"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>15<span
style='font:7.0pt "Times New Roman"'> </span></span><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ Server</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>关闭时，数据安全性如何保证？</span></h1>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>A.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>正常关闭，一般通过人工调用</span><span
lang=EN-US>kill -15 pid</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>形式关闭，</span><span
lang=EN-US>Server</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>内部会捕获</span><span
lang=EN-US>SIGTERM</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>信号，并进行处理，将内存数据全部刷盘。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>B.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>异步刷盘情况下，异常关闭（重启时，必须要进行纠错）</span></p>

<p class=MsoListParagraph style='margin-left:63.0pt;text-indent:-21.0pt'><span
lang=EN-US>a)<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>Kill -9</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>形式关闭，由于程序无法捕获</span><span
lang=EN-US>-9</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>信号，会被非法关闭。</span></p>

<p class=MsoNormal style='margin-left:63.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>此时向物理文件写消息可能会只写入半个消息，逻辑文件同样也存在这种情况，都是最后一个消息无法保证正常写入。</span></p>

<p class=MsoNormal style='margin-left:63.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>但是之前写入完整的消息虽然未刷盘，也可以保证不丢失，数据只要进入</span><span
lang=EN-US>PAGECACHE</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，即使程序</span><span
lang=EN-US>CRASH</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，仍然在内存中</span></p>

<p class=MsoNormal style='margin-left:63.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>可以通过</span><span
lang=EN-US>sync</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>命令刷盘（系统内置命令）</span></p>

<p class=MsoListParagraph style='margin-left:63.0pt;text-indent:-21.0pt'><span
lang=EN-US>b)<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US>OS CRASH</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>或机器掉电</span></p>

<p class=MsoListParagraph style='margin-left:63.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>此种情况，只要未刷盘的数据将全部丢失。</span></p>

<p class=MsoListParagraph style='margin-left:63.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>根据性能压测结果，实际在内存未刷盘数据大概在几十</span><span
lang=EN-US>K</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>的样子。也就是说最糟糕的情况会有几十</span><span
lang=EN-US>K</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>的消息丢失。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>C.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>同步刷盘情况下，异常关闭（重启时，必须要进行纠错）</span></p>

<p class=MsoNormal style='margin-left:42.0pt'><span lang=EN-US>B</span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>中涉及的两种异常情况，都不会丢消息，但是可能存在如下情况</span></p>

<p class=MsoNormal style='margin-left:42.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>当消息写入到</span><span
lang=EN-US>pagecache</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，刷盘刷到一半时，此时还未向</span><span
lang=EN-US>Producer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>返回成功，但是机器掉电或者</span><span
lang=EN-US>OS CRASH,</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>这个半个消息就是脏数据，重启时需要纠错。另外</span><span
lang=EN-US>Producer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>也会收到超时异常，由用户决定是否要重试。</span></p>

<p class=MsoNormal style='margin-left:42.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>综上，同步刷盘情况下，异常关闭不会丢消息。</span></p>

<h1><a name="_Toc345176945"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>16<span
style='font:7.0pt "Times New Roman"'> </span></span><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ Server</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>重启时，如何<span
lang=EN-US>Load</span>数据？</span></h1>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>A.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>上次正常退出后重启</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>正常退出指的是，所有内存数据都已经正常刷盘，物理分区与逻辑分区对应关系一致，恢复时各自独立恢复到内存即可。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US>B.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>上次异常退出后重启</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>异常退出指的是，物理分区与逻辑分区可能数据不一致，有可能物理分区比逻辑分区数据多，也有可能逻辑分区比物理分区数据多，这里一物理分区数据为主，从物理分区上次刷盘位置开始扫描物理分区，将消息重新派发至逻辑分区。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>如何找到上次刷盘位置？</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>“</span><span
lang=EN-US>metaStoreCheckpoint</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>”此文件会记录刷盘的时间戳，恢复时，根据时间戳来扫描物理文件，就可以找到从哪里开始恢复。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>如果此文件丢失，则会对物理文件进行全盘扫描恢复，这种情况会耗时较长。</span></p>

<h1><a name="_Toc345176946"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>17<span
style='font:7.0pt "Times New Roman"'> </span></span><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>如何区别是正常退出还是异常退出？</span></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>METAQ</span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>启动时，都会在指定目录创建一个文件“</span><span
lang=EN-US>metaStoreAbort</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>”，如果正常退出，则将文件删除，如果异常退出，则没有机会删除文件，所以在</span><span
lang=EN-US>METAQ</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>重启时，只要发现这个文件存在就认为上次是异常退出，需要校验数据，如果文件不存在，则认为上次是正常退出，数据都</span><span
lang=EN-US>OK</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>。</span></p>

<h1><a name="_Toc345176947"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>18<span
style='font:7.0pt "Times New Roman"'> </span></span><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>有哪些自我保护措施？</span></h1>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>磁盘空间使用超过</span><span
lang=EN-US>90%</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>阀值时，</span><span
lang=EN-US>Server</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>自动停止对外写服务，也就是发送方发消息会被拒绝。</span><span
lang=EN-US>Consumer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>仍然可以拉消息。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>消息向逻辑队列写入失败时，尝试重试</span><span
lang=EN-US>3</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>次，如果仍然失败，则认为</span><span
lang=EN-US>IO</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>设备发生重大错误，停止对外写服务。</span><span
lang=EN-US>Consumer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>仍然可以拉消息。</span></p>

<h1><a name="_Toc345176948"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>19<span
style='font:7.0pt "Times New Roman"'> </span></span><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>是否需要流控？</span></h1>

<p class=MsoListParagraph style='margin-left:42.6pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>对于发送消息，接收消息不需要流控</span></p>

<p class=MsoListParagraph style='margin-left:42.6pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>因为性能测试中，千兆网卡上下行同时压满（流量都在</span><span
lang=EN-US>100M</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>以上），系统指标仍然正常。但是同时需要监控磁盘空间剩余量，因为在高</span><span
lang=EN-US>TPS</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>场景下，磁盘很快就会被写满。</span></p>

<p class=MsoListParagraph style='margin-left:42.6pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>Server</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>内部将消息索引派发至各个逻辑分区需要流控</span></p>

<p class=MsoListParagraph style='margin-left:42.6pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>在</span><span
lang=EN-US>1</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>万分区以下一般不需要流控，但是一旦超过</span><span
lang=EN-US>1</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>万个分区，则对分区的写性能会下降，此时前端请求过来，索引会在</span><span
lang=EN-US>java</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>堆中堆积，默认阀值是</span><span
lang=EN-US>40</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>万，超过则开始流控，对前端请求做</span><span
lang=EN-US>1</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>毫秒</span><span
lang=EN-US>sleep</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<h1><a name="_Toc345176949"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>20<span
style='font:7.0pt "Times New Roman"'> </span></span><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>为什么可以支持海量（<span
lang=EN-US>1</span>万以上）分区？</span></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>对分区有以下两点优化</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>分区概念轻量化，分区中不真正存储消息，只存储</span><span
lang=EN-US>16</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>字节的消息索引</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>刷盘方式由之前并行刷盘改为串行刷盘，避免了磁盘竟争。</span></p>

<h1><a name="_Toc345176950"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>21<span
style='font:7.0pt "Times New Roman"'> </span></span><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>Java</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>中使用<span lang=EN-US>MapedByteBuffer</span>可能会使<span
lang=EN-US>JVM CRASH</span>，<span lang=EN-US>METAQ</span>如何避免？</span></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>使用</span><span
lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>MapedByteBuffer</span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>导致<span lang=EN-US>JVM
CRASH</span>的原因是什么？</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>由于<span
lang=EN-US>MapedByteBuffer</span>可以通过特殊方法人为释放掉，实际调用了<span lang=EN-US>unmap</span>方法。此时之前映射到<span
lang=EN-US>JVM</span>的地址空间就非法，如果此后仍然对<span lang=EN-US>MapedByteBuffer</span>进行读写，系统就会向<span
lang=EN-US>JVM</span>发送<span lang=EN-US>SIGBUS</span>信号来通知进程此种操作非法。（这种一般是由于程序员没有处理好并发问题导致）</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ</span><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>如何避免？</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>采用引用计数方法，参考<span
lang=EN-US>C++</span>智能指针实现方式。只要引用计数不为<span lang=EN-US>0</span>，<span
lang=EN-US>MapedByteBuffer</span>对象就不会释放。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>为什么不使用读写锁来避免？</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>采用引用计数使用的是原子变量，并发下要比读写锁性能更好</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>采用读写锁，每次对数据读写都要加锁，代码较冗余（个人看法）。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>这种方式存在什么弊端？</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>如果不能正确操作引用计数，可能会导致文件无法删除，所以</span><span
lang=EN-US>metaq</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>增加了一个补救措施，就是一旦关闭文件服务后，如果超过</span><span
lang=EN-US>2</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>分钟，引用计数还没有变为</span><span
lang=EN-US>0</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>，则强制释放。</span></p>

<h1><a name="_Toc345176951"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>22<span
style='font:7.0pt "Times New Roman"'> </span></span><span lang=EN-US
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>METAQ2.0</span></a><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>版本较<span lang=EN-US>1.4</span>版性能提升的主要原因是什么？</span></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>主要原因有以下两点</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>存储层的优化，之前版本不能做到真正顺序写，一旦分区过多，就会有大量的随机写出现，同时还会阻塞发送方，新版本可以做到几乎完全顺序写，同时又提高了分区数量，新版本在偶尔发生随机读写情况下，也不会对发送端做阻塞，或者极少情况下阻塞。另外存储层可以大量使用系统内存用来缓存消息。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>u<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>Producer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>端压缩消息，</span><span
lang=EN-US>Consumer</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>端解压消息</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>消息压缩解压缩只消耗</span><span
lang=EN-US>CPU</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>资源，且都是客户端</span><span
lang=EN-US>CPU</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>资源，对于服务器无任何影响，服务器直接存储压缩过的消息。</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
lang=EN-US>&nbsp;</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>消息压缩对客户端是否有影响？</span></p>

<p class=MsoListParagraph style='margin-left:42.0pt;text-indent:0cm'><span
style='font-family:"YaHei Consolas Hybrid","sans-serif"'>经测试，压缩</span><span
lang=EN-US>4K</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>的消息需要耗时</span><span
lang=EN-US>0.1~0.2</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>毫秒，基本可以忽略不计。但是带来的好处却很多</span></p>

<p class=MsoListParagraph style='margin-left:63.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>&Oslash;<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span lang=EN-US>tps</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>可以翻倍</span></p>

<p class=MsoListParagraph style='margin-left:63.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>&Oslash;<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>服务器的负载更低</span></p>

<p class=MsoListParagraph style='margin-left:63.0pt;text-indent:-21.0pt'><span
lang=EN-US style='font-family:Wingdings'>&Oslash;<span style='font:7.0pt "Times New Roman"'>&nbsp;
</span></span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>节省大量磁盘空间（典型的时间换空间）</span></p>

<h1><a name="_Toc345176952"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>23<span
style='font:7.0pt "Times New Roman"'> </span></span><span style='font-family:
"YaHei Consolas Hybrid","sans-serif"'>订阅关系丢失，是否也会丢失消息？</span></a></h1>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>不会。</span></p>

<p class=MsoNormal style='margin-left:21.0pt'><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>不管是否有人订阅消息，消息都在那里。</span></p>

<h1><a name="_Toc345176953"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>24<span
style='font:7.0pt "Times New Roman"'> </span></span><span style='font-family:
"YaHei Consolas Hybrid","sans-serif"'>存储层的刷盘策略是什么？</span></a></h1>

<p class=MsoNormal align=left style='text-align:left;page-break-after:avoid'><span
lang=EN-US><img border=0 width=436 height=409 src="storeqa.files/image003.png"></span></p>

<p class=MsoCaption align=left style='text-align:left'><span style='font-family:
黑体'>图表</span> <span
lang=EN-US>2</span><span style='font-family:黑体'>刷盘策略</span></p>

<h1><a name="_Toc345176954"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>25<span
style='font:7.0pt "Times New Roman"'> </span></span><span style='font-family:
"YaHei Consolas Hybrid","sans-serif"'>存储层目录结构？</span></a></h1>

<p class=MsoNormal align=left style='text-align:left;page-break-after:avoid'><span
lang=EN-US><img border=0 width=316 height=714 id="图片 3"
src="storeqa.files/image004.png"></span></p>

<p class=MsoCaption align=left style='text-align:left'><span style='font-family:
黑体'>图表</span> <span
lang=EN-US>3</span><span style='font-family:黑体'>存储层目录结构</span></p>

<p class=MsoNormal><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>物理分区文件大小：</span><span
lang=EN-US>8K</span></p>

<p class=MsoNormal><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>逻辑分区文件大小：</span><span
lang=EN-US>160B</span></p>

<p class=MsoNormal><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>分区数：</span><span
lang=EN-US>5</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>个</span></p>

<p class=MsoNormal><span lang=EN-US>&nbsp;</span></p>

<p class=MsoNormal><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>实际</span><span
lang=EN-US>metaq</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>默认参数如下</span></p>

<p class=MsoNormal><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>物理分区文件大小：</span><span
lang=EN-US>1G</span></p>

<p class=MsoNormal><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>逻辑分区文件大小：</span><span
lang=EN-US>2M</span></p>

<p class=MsoNormal><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>分区数：最大</span><span
lang=EN-US>1</span><span style='font-family:"YaHei Consolas Hybrid","sans-serif"'>万</span></p>

<h1><a name="_Toc345176955"><span lang=EN-US style='font-family:"YaHei Consolas Hybrid","sans-serif"'>26<span
style='font:7.0pt "Times New Roman"'> </span></span><span style='font-family:
"YaHei Consolas Hybrid","sans-serif"'>存储层视图？</span></a></h1>

<p class=MsoNormal align=left style='text-align:left;page-break-after:avoid'><span
lang=EN-US><img border=0 width=697 height=507 src="storeqa.files/image005.png"></span></p>

<p class=MsoCaption align=left style='text-align:left'><span style='font-family:
黑体'>图表</span> <span
lang=EN-US>4</span><span style='font-family:黑体'>存储层视图</span></p>

</div>

</body>

</html>
